<?phpuse Illuminate\Database\Capsule\Manager as DB;class ActivityController extends CommonController{    public function init() {        $this->table = 'activity';        $this->primaryKey = 'id';        parent::init();    }	#活动添加	public function increaseAction() {		$name	=	$this->get('name','');        $inputs		= array(			['name'=>'name','value'=>$name,'role'=>'required|unique:activity.name','msg'=>'活动名称'],		);		$result		= Validate::check($inputs);		if(	!empty($result) ){ret(1, $result);}		parent::increaseAction();    }	#活动修改	public function updateAction() {        $name	=	$this->get('name','');        $inputs		= array(            ['name'=>'name','value'=>$name,'role'=>'required','msg'=>'活动名称'],        );		$result	= Validate::check($inputs);		if(	!empty($result) ){ret(1, $result);}        parent::updateAction();    }    public function goodsListAction()    {        $id = $this->get('id', 0);        $inputs		= array(            ['name'=>'id','value'=>$id,'role'=>'required|existed:activity.id','msg'=>'活动'],        );        $result		= Validate::check($inputs);        if(	!empty($result) ){ret(1, $result);}        $this->_view->assign('id',	 $id);        $this->_view->assign('uniqid',	 uniqid());        $this->_view->assign('goods_cat',DB::table('goods_cat')->where('up','=',0)->orderBy('sortorder','desc')->get());        $this->_view->assign('label',DB::table('label')->orderBy('sortorder','desc')->get());    }    public function goodsAddAction()    {        $id = $this->get('id', 0);        $inputs		= array(            ['name'=>'id','value'=>$id,'role'=>'required|existed:activity.id','msg'=>'活动'],        );        $result		= Validate::check($inputs);        if(	!empty($result) ){ret(1, $result);}        $this->_view->assign('id',	 $id);        $this->_view->assign('uniqid',	 uniqid());        $this->_view->assign('goods_cat',DB::table('goods_cat')->where('up','=',0)->orderBy('sortorder','desc')->get());        $this->_view->assign('label',DB::table('label')->orderBy('sortorder','desc')->get());    }    public function promotionPriceAddAction()    {        $activity_id= $this->get('activity_id', 0);        $goods_id   = $this->get('goods_id', 0);        $inputs		= array(            ['name'=>'activity_id','value'=>$activity_id,'role'=>'required|existed:activity.id','msg'=>'活动'],            ['name'=>'goods_id','value'=>$goods_id,'role'=>'required|existed:goods.id','msg'=>'商品'],        );        $result		= Validate::check($inputs);        if(	!empty($result) ){ret(1, $result);}        $this->_view->assign('activity_id',	 $activity_id);        $this->_view->assign('goods_id',	 $goods_id);        $this->_view->assign('uniqid',	 uniqid());        $this->_view->assign('goods',   DB::table('goods')->find($goods_id));        $this->_view->assign('activity',DB::table('activity')->find($activity_id));    }    public function promotionPriceEditAction()    {        $activity_id= $this->get('activity_id', 0);        $goods_id   = $this->get('goods_id', 0);        $inputs		= array(            ['name'=>'activity_id','value'=>$activity_id,'role'=>'required|existed:activity.id','msg'=>'活动'],            ['name'=>'goods_id','value'=>$goods_id,'role'=>'required|existed:goods.id','msg'=>'商品'],        );        $result		= Validate::check($inputs);        if(	!empty($result) ){ret(1, $result);}        $this->_view->assign('activity_id',	 $activity_id);        $this->_view->assign('goods_id',	 $goods_id);        $this->_view->assign('promotion_id',	$this->get('promotion_id',   0));        $this->_view->assign('promotionprice',	$this->get('promotionprice', 0.00));        $this->_view->assign('uniqid',	 uniqid());        $this->_view->assign('goods',   DB::table('goods')->find($goods_id));        $this->_view->assign('activity',DB::table('activity')->find($activity_id));    }    public function goodsListGetAction() {        $id	        =intval($this->get('id', 0));        $inputs		= array(            ['name'=>'id','value'=>$id,'role'=>'required|existed:activity.id','msg'=>'活动'],        );        $result		= Validate::check($inputs);        if(	!empty($result) ){ret(1, $result);}        $sort		=$this->get('sort', 'created_at');        $order		=$this->get('order','DESC');        $page		=$this->get('page',1);        $pagesize	=$this->get('rows', 10);        $offset		=($page-1)*$pagesize;        $activityGoods=DB::table('promotion')->where('activity_id', '=', $id)->lists('goods_id');        if(empty($activityGoods)){            json(['total'=>0, 'rows'=>[]]);        }else{            $query      =DB::table('goods')->join('promotion', 'goods.id','=','promotion.goods_id')->where('activity_id', '=', $id);            $label_id   =$this->get('label_id', 0);            $status		=intval($this->get('status',0));            $keywords	=$this->get('keywords', '');            if($status>0){                switch ($status){                    case 1:                        $query	=	$query	->where('istop','=',1);                        break;                    case 2:                        $query	=	$query	->where('ishot','=',1);                        break;                    case 3:                        $query	=	$query	->where('status','=',1);                        break;                    case 4:                        $query	=	$query	->where('status','=',0);                        break;                    case 5:                        $query	=	$query	->where('isnew','=',1);                        break;                }            }            if($label_id>0){                $query	=	$query	->whereRaw('FIND_IN_SET(?,label_ids)', [$label_id]);            }            if($keywords!==''){                $query	=	$query	->where('goods.id','=', $keywords)                                    ->orWhere('goods.name','like',"%{$keywords}%")                                    ->orWhere('keywords', 'like', "%{$keywords}%")                                    ->orWhere('itemno','like', "%{$keywords}%");            }            $total		=$query->count();            $rows 		=$query->orderBy($sort,$order)->orderBy('goods.id','desc')->offset($offset)->limit($pagesize)                                ->select('goods.*', 'promotion.promotionprice', 'promotion.id as promotion_id')                                ->get();            json(['total'=>$total, 'rows'=>$rows]);        }    }    public function allGoodsListGetAction() {        $id	        =intval($this->get('id', 0));        $inputs		= array(            ['name'=>'id','value'=>$id,'role'=>'required|existed:activity.id','msg'=>'活动'],        );        $result		= Validate::check($inputs);        if(	!empty($result) ){ret(1, $result);}        $label_id   =$this->get('label_id', 0);        $keywords	=$this->get('keywords', '');        $trashed	=intval($this->get('trashed', 0));        $sort		=$this->get('sort', 'created_at');        $order		=$this->get('order','DESC');        $page		=$this->get('page',1);        $pagesize	=$this->get('rows', 10);        $offset		=($page-1)*$pagesize;        $query		=new goodsModel;        $activityGoods=DB::table('promotion')->where('activity_id', '=', $id)->lists('goods_id');        if(!empty($activityGoods)){            $query = $query->whereNotIn('id', $activityGoods);        }        $status		=intval($this->get('status',0));        if($status>0){            switch ($status){                case 1:                    $query	=	$query	->where('istop','=',1);                    break;                case 2:                    $query	=	$query	->where('ishot','=',1);                    break;                case 3:                    $query	=	$query	->where('status','=',1);                    break;                case 4:                    $query	=	$query	->where('status','=',0);                    break;                case 5:                    $query	=	$query	->where('isnew','=',1);                    break;            }        }        if($label_id>0){            $query	=	$query	->whereRaw('FIND_IN_SET(?,label_ids)', [$label_id]);        }        if($keywords!==''){            $query	=	$query	->where('goods.id','=', $keywords)                                ->orWhere('name','like',"%{$keywords}%")                                ->orWhere('keywords', 'like', "%{$keywords}%")                                ->orWhere('itemno','like', "%{$keywords}%");        }        $stock	=$this->get('stock','');        if($stock!==''){            $query	=	$query->where('stock','<=',intval($stock));        }        if($trashed===1){            $query	=	$query	->where('deleted_at','<>','0000-00-00 00:00:00');        }else{            $query	=	$query	->where('deleted_at','=','0000-00-00 00:00:00');        }        $start_on	=$this->get('start_on', '');        if(!empty($start_on)){            $query	=	$query	->where('updated_at','>=',$start_on);        }        $end_on	    =$this->get('end_on', '');        if(!empty($end_on)){            $query	=	$query	->where('updated_at','<=',$end_on);        }        $total		= $query->count();        $rows 		= $query->orderBy($sort,$order)->orderBy('id','desc')->offset($offset)->limit($pagesize)->get()->toArray();        json(['total'=>$total, 'rows'=>$rows]);    }    public function goodsListIncreaseAction(){        $activity_id= $this->get('activity_id', 0);        $goods_id   = $this->get('goods_id', 0);        $promotionprice = $this->get('promotionprice', 0.00);        $inputs		= array(            ['name'=>'activity_id','value'=>$activity_id,'role'=>'required|existed:activity.id','msg'=>'活动'],            ['name'=>'goods_id','value'=>$goods_id,'role'=>'required|existed:goods.id','msg'=>'商品'],            ['name'=>'promotionprice','value'=>$promotionprice,'role'=>'required|gt:0.00','msg'=>'促销价格'],        );        $result		= Validate::check($inputs);        if(	!empty($result) ){ret(1, $result);}        $rows = array(            'activity_id'   =>  $activity_id,            'goods_id'      =>  $goods_id,            'promotionprice'=>  $promotionprice,        );        DB::table('promotion')->insert($rows);        ret(0, '操作成功');    }    public function goodsListUpdateAction(){        $promotion_id= $this->get('promotion_id', 0);        $promotionprice = $this->get('promotionprice', 0.00);        $inputs		= array(            ['name'=>'promotion_id','value'=>$promotion_id,'role'=>'required|existed:promotion.id','msg'=>'活动商品'],            ['name'=>'promotionprice','value'=>$promotionprice,'role'=>'required|gt:0.00','msg'=>'促销价格'],        );        $result		= Validate::check($inputs);        if(	!empty($result) ){ret(1, $result);}        DB::table('promotion')->where('id', '=', $promotion_id)->update(['promotionprice'=>$promotionprice]);        ret(0, '操作成功');    }    public function goodsListDeleteAction(){        $promotion_id= $this->get('promotion_id', 0);        $inputs		= array(            ['name'=>'promotion_id','value'=>$promotion_id,'role'=>'required|existed:promotion.id','msg'=>'活动商品'],        );        $result		= Validate::check($inputs);        if(	!empty($result) ){ret(1, $result);}        DB::table('promotion')->delete($promotion_id);        ret(0, '操作成功');    }}